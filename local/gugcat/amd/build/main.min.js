define(["jquery","core/str","core/modal_factory","local_gugcat/modal_gcat","core/sessionstorage","core/ajax"],function(e,t,a,n,l,c){const r=e=>{return window.location.pathname.match(e)},o=e=>{document.querySelectorAll(".input-reason").forEach(t=>t.value=e)},i=()=>{var e=document.getElementById("btn-identities"),a=document.querySelectorAll(".blind-marking");if(e&&a.length>0){e.textContent="...",a.forEach(e=>e.classList.add("hide-names"));var n="true"==l.get("blind-marking");t.get_strings([{key:"showidentities",component:"local_gugcat"},{key:"hideidentities",component:"local_gugcat"}]).then(function(t){e.textContent=n?t[0]:t[1],a.forEach(e=>{n?e.classList.add("hide-names"):e.classList.remove("hide-names")})})}},d=e=>{var t,a,n,l,c,r,o,i,d=0;for(t=document.getElementById("gcat-table"),n=!0,i="asc";n;){for(n=!1,a=t.rows,l=1;l<a.length-1;l++)if(o=!1,c=a[l].getElementsByTagName("TD")[e],r=a[l+1].getElementsByTagName("TD")[e],"asc"==i){if(c.innerHTML.toLowerCase()>r.innerHTML.toLowerCase()){o=!0;break}}else if("desc"==i&&c.innerHTML.toLowerCase()<r.innerHTML.toLowerCase()){o=!0;break}o?(a[l].parentNode.insertBefore(a[l+1],a[l]),n=!0,d++):0==d&&"asc"==i&&(i="desc",n=!0)}},s=(e,l,c,r="cancelmodal")=>{var o=[{key:l,component:"local_gugcat"},{key:r,component:"local_gugcat"},{key:c,component:"local_gugcat"}];t.get_strings(o).then(function(t){var l={bodycontent:t[0],strcancel:t[1],strconfirm:t[2],dataaction:e};a.create({type:n.TYPE,templateContext:l}).done(e=>e.show())})},u=e=>{var t=new URLSearchParams(window.location.search),a=document.getElementById("select-category"),n=document.getElementById("select-activity"),l=document.getElementById("select-child-act"),c=document.getElementById("select-grade-reason"),i=document.getElementById("input-reason"),d=document.getElementById("id_reasons");switch(e.target){case a:if(t.delete("activityid"),t.delete("page"),t.delete("childactivityid"),"null"===a.value?t.delete("categoryid"):t.set("categoryid",a.value),r("gugcat/add")){t.delete("studentid");var s=window.location.pathname;return s=s.replace("gugcat/add","gugcat")+"?"+t,void window.location.replace(s)}window.location.search=t;break;case n:t.set("activityid",n.value),t.delete("childactivityid"),t.delete("page"),window.location.search=t;break;case l:t.set("childactivityid",l.value),t.delete("page"),window.location.search=t;break;case c:var u=e.target.value;o(u),"Other"===u?(o(""),i.style.display="block"):i.style.display="none";break;case d:var g=e.target.value,m=document.getElementById("id_otherreason");m.value=g,(g="8")?(m.value="",m.required=!0):m.required=!1,m.focus()}},g=a=>{var n=document.getElementById("btn-saveadd"),r=document.getElementById("btn-release"),o=document.getElementById("btn-import"),d=document.getElementById("btn-identities"),u=document.getElementById("btn-coursegradeform"),g=document.getElementById("btn-download"),m=document.getElementById("btn-finalrelease"),y=document.getElementById("btn-switch-display"),v=document.getElementById("btn-blkimport");switch(a.target){case n:n.classList.toggle("togglebtn"),n.style.display="none",t.get_string("saveallnewgrade","local_gugcat").then(function(e){n.style.display="inline-block",n.classList.contains("togglebtn")?n.textContent=e:document.getElementById("multiadd-submit").click()}),e(".togglemultigrd").show();break;case r:s("release","modalreleaseprovisionalgrade","confirmreleaseprovisionalgrade");break;case o:e(".gradeitems").text().includes("Moodle Grade[Date]")?document.getElementById("importgrades-submit").click():s("importgrades","modalimportgrades","confirmimport");break;case u:var f=document.querySelectorAll(".input-percent"),h=0;f.length>0&&f.forEach(e=>{var t=e.querySelector("input");h+=parseInt(t.value),null!=e.querySelector("input.is-invalid")?e.querySelector("div.felement").classList.add("no-after"):e.querySelector("div.felement").classList.remove("no-after")}),100!=h?s("adjustweight","modaladjustweights","confirmchanges"):document.getElementById("coursegradeform-submit").click();break;case m:s("finalrelease","modalreleasefinalgrades","confirmfinalrelease");break;case g:document.getElementById("downloadcsv-submit").click();break;case d:var p="true"==l.get("blind-marking");l.set("blind-marking",!p),i();break;case y:(()=>{var e=document.getElementById("btn-switch-display"),a=new URLSearchParams(window.location.search).get("id");e&&(e.textContent="...",c.call([{methodname:"local_gugcat_display_assessments",args:{courseid:a}}])[0].done(function(a){var n=a.result;t.get_strings([{key:"switchoffdisplay",component:"local_gugcat"},{key:"switchondisplay",component:"local_gugcat"}]).then(function(t){e.textContent=n?t[0]:t[1]})}).fail(function(){e.style.display="none"}))})();break;case v:e(".gradeitems").text().includes("Moodle Grade[Date]")?document.getElementById("bulk-submit").click():s("bulkimportgrades","modalimportgrades","confirmimport")}};return{init:function(){const a=document.querySelector(".gcat-container");if(a){a.addEventListener("change",u),a.addEventListener("click",g),document.getElementById("btn-identities")&&!l.get("blind-marking")&&l.set("blind-marking",!1),i(),(b=document.querySelectorAll(".btn-colexp")).length>0&&b.forEach(e=>{e.addEventListener("click",t=>{var a=t.target.getAttribute("data-categoryid"),n=document.querySelectorAll(`[data-category="${a}"]`),l=e.querySelector(".i-colexp");n.forEach(e=>{e.classList.toggle("hidden"),e.classList.contains("hidden")?(l.classList.add("fa-plus"),l.classList.remove("fa-minus")):(l.classList.remove("fa-plus"),l.classList.add("fa-minus"))}),document.querySelectorAll(`.catid-${a}`).forEach(e=>e.classList.toggle("hidden"))})});var n=document.getElementById("input-reason");n&&n.addEventListener("input",e=>{o(e.target.value)});var c=document.querySelectorAll(".input-search");c.length>0&&c.forEach(e=>{e.addEventListener("keydown",e=>{13===(e.keyCode?e.keyCode:e.which)&&document.getElementById("search-submit").click()})});var s=document.querySelectorAll(".input-percent");if(s.length>0){var m=0,y=document.querySelector("#fitem_id_totalweight .form-inline");s.forEach(e=>{var t=e.querySelector("input");m+=parseInt(t.value),t.addEventListener("input",e=>{let t=0;s.forEach(e=>t+=parseInt(e.querySelector("input").value)),y.innerHTML=`${t}%`}),t.addEventListener("focus",t=>{var a=t.target.value;""!==a&&null===a.match(/^[0-9]+$/)?e.querySelector("div.felement").classList.add("no-after"):e.querySelector("div.felement").classList.remove("no-after")}),t.addEventListener("blur",t=>{var a=t.target.value;""!==a&&null===a.match(/^[0-9]+$/)?e.querySelector("div.felement").classList.add("no-after"):e.querySelector("div.felement").classList.remove("no-after")})}),y.innerHTML=`${m}%`}var v=document.querySelectorAll(".sortable");if(v.length>0)for(const[e,t]of v.entries())t.addEventListener("click",()=>d(e));var f=document.querySelectorAll(".fa-search");if(f.length>0&&f.forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.blur();var t=e.target.nextSibling;t.classList.toggle("visible"),t.classList.contains("visible")?t.style.display="block":t.style.display="none"})}),document.querySelectorAll("td .grade-discrepancy").length>0&&(document.getElementById("btn-grddisc").style.display="inline-block"),r("gugcat/overview"))document.querySelector("#btn-overviewtab").classList.add("active"),document.querySelector("#btn-assessmenttab").classList.remove("active"),(p=document.getElementById("id_notes"))&&(async()=>{p.placeholder=await t.get_string("specifyreason","local_gugcat"),p.required=!0})();else if(r("gugcat/index")){if(document.getElementById("btn-release").style.display=e(".gradeitems").text().includes("Moodle Grade[Date]")?"none":"inline-block",Array.from(document.querySelectorAll(".gradeitems")).find(e=>"Moodle Grade<br>[Date]"!==e.innerHTML))document.getElementById("btn-saveadd").style.display="inline-block",document.querySelectorAll(".addnewgrade").forEach(e=>{e.style.display="block"}),document.querySelectorAll(".hide-show-grade").forEach(e=>{e.style.display="block"})}else if(r("gugcat/add")||r("gugcat/edit")){var h=document.getElementById("id_otherreason"),p=document.getElementById("id_notes");(async()=>{h.placeholder=await t.get_string("pleasespecify","local_gugcat"),p.placeholder=await t.get_string("specifyreason","local_gugcat"),p.required=!0})()}}var b}}});